YUI.add("moodle-mod_mediagallery-base",function(n,e){M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.base={defaultitemwidth:187,courseid:0,mid:0,gallery:0,lbg_setup_ran:!1,options:{enablecomments:!1,enablelikes:!1,mode:"standard"},uri:M.cfg.wwwroot+"/mod/mediagallery/rest.php",init:function(e,t,o,a,i,l){this.courseid=e,this.mid=t,this.gallery=i,l&&l.enablecomments&&(this.options.enablecomments=!0),l&&l.enablelikes&&(this.options.enablelikes=!0),l&&l.mode&&(this.options.mode=l.mode),!a&&"gallery"!==o||("thebox"!==this.options.mode?this.watch_editing_buttons(o):this.watch_delete_thebox(o)),0===i&&"gallery"===o&&this.add_remove_collection_handler(),a||this.watch_mediasize(),this.setup_sample_link(),this.watch_resize()},add_remove_collection_handler:function(){var a,i,l,e=n.one(".collection.actions .remove");e&&(a=e.hasClass("owner"),i={title:M.str.mod_mediagallery.confirmcollectiondelete,question:M.str.mod_mediagallery.removecollectionconfirm,yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel},l={"class":"collection",id:this.mid},this._confirmationListener=this._confirmationListener||e.on("click",function(e){var t,o;e.preventDefault(),a?(o=M.str.mod_mediagallery.deleteorremovecollection,o+='<br/><input type="textbox" name="deleteorremove"/><br/>',o+=M.str.mod_mediagallery.deleteorremovecollectionwarn,i.question='<div class="deleteorremove">'+o+"</div>",(t=new M.core.confirm(i)).on("complete-yes",function(){l.action="remove";var e=n.one('input[name="deleteorremove"]');if(e)if("DELETE"===e.get("value").toUpperCase())l.action="delete";else if(""!==e.get("value"))return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(l)},this)):(t=new M.core.confirm(i),l.action="remove",t.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(l)},this)),t.show()},this))},watch_delete_thebox:function(l){var s,r=".gallery_list_item";"item"===l&&(r=".item"),s={title:M.str.mod_mediagallery["confirm"+l+"delete"],yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel},n.all(r+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(e){var t,o,a,i;e.preventDefault(),t=this.hasClass("owner"),(o=this.ancestor("div"+r).getData())["class"]=l,t?(i=M.str.mod_mediagallery["deleteorremove"+l],i+='<br/><input type="textbox" name="deleteorremove"/><br/>',i+=M.str.mod_mediagallery["deleteorremove"+l+"warn"],s.question='<div class="deleteorremove">'+i+"</div>",(a=new M.core.confirm(s)).on("complete-yes",function(){o.action="remove";var e=n.one('input[name="deleteorremove"]');if(e)if("DELETE"===e.get("value").toUpperCase())o.action="delete";else if(""!==e.get("value"))return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(o,r)},this)):(s.question=M.str.mod_mediagallery["remove"+l+"confirm"],a=new M.core.confirm(s),o.action="remove",a.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(o,r)},this)),a.show()},this)})},watch_editing_buttons:function(a){var i,l=".gallery_list_item";"item"===a&&(l=".item"),i={title:M.str.mod_mediagallery["confirm"+a+"delete"],origquestion:M.str.mod_mediagallery["delete"+a]+" ",yesLabel:M.str.moodle.yes,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel},n.all(l+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(e){var t,o;e.preventDefault(),t=this.ancestor("div"+l).getData(),i.question=i.origquestion+t.title+"?",(o=new M.core.confirm(i)).on("complete-yes",function(){this._confirmationListener.detach(),t["class"]=a,M.mod_mediagallery.base.delete_object(t,l)},this),o.show()},this)})},watch_mediasize:function(){var e=".mediasize_selector select",i=".gallery";n.one(e)&&n.one(e).on("change",function(e){var t,o,a;e.preventDefault(),(t=n.one(i)).removeClass("small"),t.removeClass("large"),a="","0"===(o=e.target.get("value"))?a="small":"2"===o&&(a="large"),""!==a&&t.addClass(a),M.util.set_user_preference("mod_mediagallery_mediasize",o)})},add_gallery_info_modal:function(e,t){var o,a,i=n.Node.create('<div class="metainfo"></div>'),l='<a href="'+M.cfg.wwwroot+"/user/view.php?id="+t.userid;l+="&course="+e+'">'+t.firstname+" "+t.lastname+"</a>",o=[[M.str.mod_mediagallery.galleryname,t.name],[M.str.mod_mediagallery.creator,l]],null!==t.groupname&&o.push([M.str.moodle.group,t.groupname]),n.each(o,function(e){n.Node.create('<div class="field">'+e[0]+'</div><div class="value">'+e[1]+"</div>").appendTo(i)}),a={headerContent:M.str.mod_mediagallery.information,bodyContent:i,modal:!0},n.one(".gallery_list_item[data-id="+t.id+"] .action-icon.info").on("click",function(e){e.preventDefault(),new M.core.dialogue(a).show()})},add_item_info_modal:function(e){var t,a=n.Node.create('<div class="metainfo"></div>'),i=[[M.str.mod_mediagallery.caption,e.caption],[M.str.mod_mediagallery.datecreated,e.timecreatedformatted],[M.str.moodle.fullnameuser,e.firstname+" "+e.lastname],[M.str.moodle.username,e.username],[M.str.moodle.group,e.groupname],[M.str.moodle.description,e.description],[M.str.mod_mediagallery.moralrights,"1"==e.moralrights?M.str.moodle.yes:M.str.moodle.no],[M.str.mod_mediagallery.copyright,e.copyrightformatted],[M.str.mod_mediagallery.originalauthor,e.originalauthor],[M.str.mod_mediagallery.productiondate,e.productiondateformatted],[M.str.mod_mediagallery.medium,e.medium],[M.str.mod_mediagallery.publisher,e.publisher],[M.str.mod_mediagallery.broadcaster,e.broadcaster],[M.str.mod_mediagallery.reference,e.reference],[M.str.mod_mediagallery.tags,e.tags]];n.each(i,function(e,t){var o=!0;4!==t&&3!==t&&7!=t||null!==i[t][1]&&""!==i[t][1]||(o=!1),o&&n.Node.create('<div class="field">'+e[0]+'</div><div class="value">'+e[1]+"</div>").appendTo(a)}),t={headerContent:M.str.mod_mediagallery.information,bodyContent:a,modal:!0},n.one(
".item[data-id="+e.id+"] .action-icon.info").on("click",function(e){e.preventDefault(),new M.core.dialogue(t).show()})},delete_object:function(i,l){var e,s=!1;i.m=this.mid,i.sesskey=M.cfg.sesskey,e={method:"DELETE",data:i,on:{success:function(e,t){try{var o=n.JSON.parse(t.responseText);o.error&&new M.core.ajaxException(o)}catch(a){new M.core.ajaxException}s&&window.setTimeout(function(){s.hide()},400),l&&n.one(l+"[data-id="+i.id+"]").remove(),"collection"===i["class"]&&(window.location.href=M.cfg.wwwroot+"/course/view.php?id="+this.courseid)},failure:function(){s&&s.hide()}},context:this,sync:!0},s&&s.show(),n.io(M.mod_mediagallery.base.uri,e)},lbg_setup:function(){var e,t;this.lbg_setup_ran||(this.lbg_setup_ran=!0,e=n.one(".lb-social"),t='<div class="lb-extradetails"></div><div class="lb-socialactions">',this.options.enablelikes&&(t+='<a class="like" href="#"><div class="like"></div>',t+=M.str.mod_mediagallery.like+'</a><span id="lb-likedby"></span>'),t+='<span id="lb-fullsize"></span></div><div id="lb-comments"></div>',e.setHTML(t),n.delegate("click",function(e){var t,a,o,i,l,s;e.preventDefault(),t="like",a=1,o="unlike",i='<div class="unlike"></div>',n.one(".lb-socialactions a.like div").hasClass("unlike")&&(t="unlike",a=0,o="like",i='<div class="like"></div>'),l=n.one(".lb-data"),s={method:"POST",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:l.getData("itemid"),"class":"item",action:t},on:{success:function(e,t){var o=JSON.parse(t.responseText);M.mod_mediagallery.base.update_likes(o.likes,a)}},context:this,sync:!0},n.io(M.mod_mediagallery.base.uri,s),n.one(".lb-socialactions a.like").setHTML(i+M.str.mod_mediagallery[o])},".lb-social",".lb-socialactions a.like"))},update_likes:function(e,t){var o="";0<e&&(o="&nbsp;&bull;&nbsp;",o+=M.str.mod_mediagallery.likedby+": ",t&&(--e,o+=M.str.mod_mediagallery.you+", "),o+=e+" ",o+=1!=e?M.str.mod_mediagallery.others:M.str.mod_mediagallery.other),n.one("#lb-likedby").setHTML(o)},lbg_change:function(s,e){var r,t;this.lbg_setup_ran||this.lbg_setup(),n.one(".lb-data").setData("itemid",s.itemid),"0"!==s.player&&"2"!==s.player||this.lbg_embed_player(s.itemid,e),r=n.one(".lb-data"),t={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:r.getData("itemid"),"class":"item",action:"socialinfo"},on:{success:function(e,t){var o,a,i,l=JSON.parse(t.responseText);l.commentcontrol&&(n.one("#lb-comments").setHTML(l.commentcontrol),o={client_id:l.client_id,contextid:l.contextid,itemid:r.getData("itemid"),component:"mod_mediagallery",commentarea:"item"},M.core_comment.init(n,o)),this.options.enablelikes&&(a='<div class="like"></div>',l.likedbyme?(a='<div class="unlike"></div>',n.one(".lb-socialactions a.like").setHTML(a+M.str.mod_mediagallery.unlike)):n.one(".lb-socialactions a.like").setHTML(a+M.str.mod_mediagallery.like),M.mod_mediagallery.base.update_likes(l.likes,l.likedbyme)),i="","1"===s.player&&(this.options.enablelikes&&(i+="&nbsp;&bull;&nbsp;"),i+='<a href="'+s.url+'?forcedownload=0" target="_blank">',i+=M.str.mod_mediagallery.viewfullsize+"</a>"),n.one("#lb-fullsize").setHTML(i),l.extradetails&&n.one(".lb-social .lb-extradetails").setHTML(l.extradetails)}},context:this,sync:!0},n.io(M.mod_mediagallery.base.uri,t)},lbg_embed_player:function(e,a){var t={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"item",action:"embed",id:e},on:{success:function(e,t){var o=JSON.parse(t.responseText);n.one(".lb-image").ancestor().append(o.html),"audio"===o.type?M.util.add_audio_player(o.id,o.url,!1):M.util.add_video_player(o.id,o.url,!1),M.mod_mediagallery.base.load_flowplayer(),"video"===o.type&&a.sizeContainer(400,400)}},context:this,sync:!0};n.io(M.mod_mediagallery.base.uri,t)},load_flowplayer:function(){var e,t,o;0==M.util.video_players.length&&0==M.util.audio_players.length||(e=function(){var e,t,o,a,i,l,s,r={autoHide:!0};for(e=0;e<M.util.video_players.length;e++)o=0<(t=M.util.video_players[e]).width&&0<t.height?{src:M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",width:t.width,height:t.height}:M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",flowplayer(t.id,o,{plugins:{controls:r},clip:{url:t.fileurl,autoPlay:!1,autoBuffering:!0,scaling:"fit",mvideo:t,onMetaData:function(e){var t,o,a,i;e.mvideo.autosize&&!e.mvideo.resized&&(e.mvideo.resized=!0,o=t=0,o="undefined"==typeof e.metaData.width||"undefined"==typeof e.metaData.height?(t=e.width,e.height):(t=e.metaData.width,e.metaData.height),t<(a=300)&&(o=o*a/t,t=a),(i=this._api()).width=t,i.height=o)}}});if(M.util.video_players=[],0!=M.util.audio_players.length){for(r={autoHide:!1,fullscreen:!1,next:!1,previous:!1,scrubber:!0,play:!0,pause:!0,volume:!0,mute:!1,backgroundGradient:[.5,0,.3]},i=0;i<document.styleSheets.length;i++){l=!1;try{if("undefined"!=typeof document.styleSheets[i].rules)l=document.styleSheets[i].rules;else{if("undefined"==typeof document.styleSheets[i].cssRules)continue;l=document.styleSheets[i].cssRules}}catch(n){continue}if(l){for(e=0;e<l.length;e++)a="",/^\.mp3flowplayer_.*Color$/.test(l[e].selectorText)&&("undefined"!=typeof l[e].cssText?a=l[e].cssText:"undefined"!=typeof l[e].style.cssText&&(a=l[e].style.cssText),""!=a&&/.*color\s*:\s*([^;]+).*/gi.test(a)&&(a=a.replace(/.*color\s*:\s*([^;]+).*/gi,"$1"),r[l[e].selectorText.replace(/^\.mp3flowplayer_/,"")]=a));l=!1}}for(e=0;e<M.util.audio_players.length;e++)(s=M.util.audio_players[e]).small?(r.controlall=!1,r.height=15,r.time=!1):(r.controlall=!0,r.height=25,r.time=!0),flowplayer(s.id,M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",{plugins:{controls:r,audio:{url:M.cfg.wwwroot+"/lib/flowplayer/flowplayer.audio-3.2.11.swf"}},clip:{url:s.fileurl,provider:"audio",autoPlay:!1}});M.util.audio_players=[]}},"undefined"==typeof flowplayer?(t=-1==M.cfg.jsrev?M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js":M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+M.cfg.jsrev,(o=document.createElement("script")).setAttribute("type",
"text/javascript"),o.setAttribute("src",t),o.onload=e,o.onreadystatechange=e,document.getElementsByTagName("head")[0].appendChild(o)):e())},setup_sample_link:function(){var t={title:M.str.mod_mediagallery.addsamplegallery,question:'<img src="'+M.util.image_url("i/loading_small")+'" title="Processing..." />',yesLabel:M.str.moodle.add,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};n.one("#mg_sample")&&n.one("#mg_sample").on("click",function(l){var s,e;l.preventDefault(),s=new M.core.confirm(t),e={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"get_sample_targets"},on:{success:function(e,t){var o,a,i;try{(o=n.JSON.parse(t.responseText)).error&&new M.core.ajaxException(o)}catch(l){new M.core.ajaxException}a=n.Node.create('<div class="sample_target_wrapper"><span>'+M.str.mod_mediagallery.mediagallery+":</span></div>"),i=n.Node.create('<select id="sample_target"/>'),a.append(i),n.Object.each(o,function(e,t){n.Node.create('<option value="'+t+'">'+e+"</option>").appendTo(i)}),s.bodyNode.one(".confirmation-message").setHTML(a)},failure:function(e,t){}},context:this,sync:!0},n.io(M.mod_mediagallery.base.uri,e),s.on("complete-yes",function(){var e=n.one("#sample_target").get("value"),t={method:"POST",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"sample","data[]":e},on:{success:function(e,t){try{var o=n.JSON.parse(t.responseText);o.error&&new M.core.ajaxException(o)}catch(l){new M.core.ajaxException}},failure:function(){}},context:this,sync:!0};n.io(M.mod_mediagallery.base.uri,t)},this),s.show()})},watch_resize:function(){var t=n.one(".gallery_items.editing");t&&t.on("windowresize",function(){var e=t.get("offsetWidth"),o=Math.floor(e/M.mod_mediagallery.base.defaultitemwidth),a=n.Node.create('<div class="rowdivider clearfix"></div>');t.all(".rowdivider").remove(),t.all(".item").each(function(e,t){t%o==0&&e.insert(a,"before")})})}},M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.dragdrop={CSS:{CONTAINER:".gallery_items",ITEMS:".gallery_items .item",CONTROLCONTAINER:".controls",HANDLE:".controls :first-child",HANDLELINK:".controls .move"},init:function(){var a="i/move_2d",i="moodle",l=!1,s=0,e=n.Node.all(this.CSS.ITEMS);e.each(function(e){var t=M.mod_mediagallery.dragdrop.CSS,o=n.Node.create('<img class="smallicon move action-icon" title="'+M.str.moodle.move+'"/>');o.setAttribute("src",M.util.image_url(a,i)),o.addClass("cursor"),e.one(t.CONTROLCONTAINER).prepend(o),new n.DD.Drag({node:e,target:{padding:"0 0 0 20"}}).plug(n.Plugin.DDProxy,{moveOnEnd:!1}).plug(n.Plugin.DDConstrained,{constrain2node:t.CONTAINER}).addHandle(t.HANDLE)}),n.DD.DDM.on("drag:start",function(e){e.preventDefault();var t=e.target;t.get("node").setStyle("opacity",".25"),t.get("dragNode").addClass("mod_mediagallery item"),t.get("dragNode").set("innerHTML",t.get("node").get("innerHTML")),t.get("dragNode").setStyles({opacity:".5",borderColor:t.get("node").getStyle("borderColor"),backgroundColor:t.get("node").getStyle("backgroundColor")})}),n.DD.DDM.on("drag:end",function(e){e.target.get("node").setStyles({visibility:"",opacity:"1"}),M.mod_mediagallery.dragdrop.save()}),n.DD.DDM.on("drag:drag",function(e){var t=e.target.lastXY[0],o=e.target.lastXY[1];l=t<s,s=t,0}),n.DD.DDM.on("drop:over",function(e){var t=e.drag.get("node"),o=e.drop.get("node"),a=n.all(M.mod_mediagallery.dragdrop.CSS.ITEMS);l=a.indexOf(o)<a.indexOf(t),o.hasClass("item")&&(l||(o=o.get("nextSibling")),e.drop.get("node").get("parentNode").insertBefore(t,o),e.drop.sizeShim())}),n.DD.DDM.on("drag:drophit",function(e){var t=e.drop.get("node"),o=e.drag.get("node");t.hasClass("item")||t.contains(o)||t.appendChild(o)})},save:function(){var e=n.one(this.CSS.CONTAINER).get("children").getData("id"),t={sesskey:M.cfg.sesskey,data:e,"class":"gallery",m:M.mod_mediagallery.base.mid,id:M.mod_mediagallery.base.gallery,action:"sortorder"};n.io(M.cfg.wwwroot+"/mod/mediagallery/rest.php",{method:"POST",data:build_querystring(t),context:this})}}},"@VERSION@",{requires:["base","node","selector-css3","dd-constrain","dd-proxy","dd-drop","dd-plugin","moodle-core-notification","event"]});