YUI.add("moodle-mod_mediagallery-mediabox",function(h,e){var t=function(){t.superclass.constructor.apply(this,arguments)};h.extend(t,h.Base,{initializer:function(){this.enable(),this.build(),this._sidebarwidth=300,this._navbarheight=60,this.currentitem=null,this._audiowidth=250,this._audioheight=275,this._videowidth=640,this._videoheight=390,this._fullscreenavail=screenfull.enabled&&!h.one("body").hasClass("ui-mobile-viewport"),this._loadingimage=h.Node.create("<img/>").setAttribute("src",M.util.image_url("loading","mod_mediagallery"))},build:function(){var e,t,i,a,n,l=this,o=M.str.moodle.next,d=M.str.moodle.previous,r=M.util.get_string("download","mod_mediagallery"),s=M.util.get_string("thisdirection","core_langconfig"),m=M.str.mod_mediagallery.togglesidebar,c=M.str.mod_mediagallery.togglefullscreen,u=M.str.mod_mediagallery.close,b='<img class="sidebartoggle" src="';for(b+=M.util.image_url("toggle","mod_mediagallery")+'" title="'+m+'" alt="'+m+'"/>',"ltr"===s?(b+='<img class="prev" src="',b+=M.util.image_url("left","mod_mediagallery")+'" title="'+o+'" alt="'+o+'"/>',b+='<img class="next" src="',b+=M.util.image_url("right","mod_mediagallery")+'" title="'+d+'" alt="'+d+'"/>'):(b+='<img class="prev" src="',b+=M.util.image_url("right","mod_mediagallery")+'" title="'+o+'" alt="'+o+'"/>',b+='<img class="next" src="',b+=M.util.image_url("left","mod_mediagallery")+'" title="'+d+'" alt="'+d+'"/>'),b+='<img class="open" src="',b+=M.util.image_url("download","mod_mediagallery")+'" title="'+r+'" alt="'+r+'"/>',this._fullscreenavail&&(b+='<img class="fullscreen" src="'+M.util.image_url("fullscreen","mod_mediagallery"),b+='" title="'+c+'" alt="'+c+'"/>'),b+='<img class="mbclose" src="',e='<div id="mediabox"><div id="mediabox-content-wrap"><div id="mediabox-content"></div></div>',e+='<div id="mediabox-sidebar">',e+='<div id="mediabox-metainfo"></div><hr/>',e+='<div id="mediabox-social"></div><hr/><div id="mediabox-comments"></div>',e+="</div>",e+='<div id="mediabox-sidebar-actions">'+(b+=M.util.image_url("close","mod_mediagallery")+'" title="'+u+'" alt="'+u+'"/>')+"</div>",e+='<div id="mediabox-navbar"><div id="mediabox-navbar-container"></div></div></div>',e+='<div id="mediabox-overlay"></div>',h.Node.create(e).appendTo("body"),this.overlay=h.one("#mediabox-overlay"),this.mediabox=h.one("#mediabox"),this.navbar=h.one("#mediabox-navbar"),this.resizeoverlay(),this.album=h.all("a[rel^=mediabox], area[rel^=mediabox], a[data-mediabox], area[data-mediabox]").getDOMNodes(),this.overlay.on("click",function(){l.stop()}),h.delegate("click",function(e){if("mediabox-navbar-container"===e.currentTarget.get("id"))return!1;l.stop()},"#mediabox","#mediabox-navbar, #mediabox-navbar-container"),h.one("#mediabox-sidebar-actions .sidebartoggle").on("click",function(){l.mediabox.toggleClass("sidebarhidden"),l.resizeoverlay(),l.repositionitem()}),t=0;t<this.album.length;t++)(i=h.Node.create('<div class="navitem"></div>')).setAttribute("data-id",t),(a=h.Node.create("<img/>")).setAttribute("src",this.album[t].children[0].getAttribute("src")),a.appendTo(i),i.appendTo("#mediabox-navbar-container");h.delegate("click",function(e){e.preventDefault(),l.changeitem(e.currentTarget.getAttribute("data-id"))},"#mediabox-navbar",".navitem"),this.get("enablelikes")&&(n='<a class="like" href="#"><div class="like"></div>',n+=M.str.mod_mediagallery.like+'</a><span id="mediabox-likedby"></span>',h.Node.create(n).appendTo("#mediabox-social")),h.delegate("click",function(e){var t,a,i,n,o,d;e.preventDefault(),t="like",a=1,i="unlike",n='<div class="unlike"></div>',h.one("#mediabox-social a.like div").hasClass("unlike")&&(t="unlike",a=0,i="like",n='<div class="like"></div>'),(o=l.get("metainfodata")).id=l.album[l.currentitemindex].getAttribute(l.get("dataidfield")),o.action=t,d={method:"POST",data:o,on:{success:function(e,t){var i=JSON.parse(t.responseText);l.update_likes(i.likes,a)}},context:this,sync:!0},h.io(l.get("metainfouri"),d),h.one("#mediabox-social a.like").setHTML(n+M.str.mod_mediagallery[i])},"#mediabox","#mediabox-social a.like"),h.delegate("blur",function(){l.enablenav()},"#mediabox","#mediabox-comments textarea"),h.delegate("focus",function(){l.disablenav()},"#mediabox","#mediabox-comments textarea"),h.one("#mediabox-sidebar-actions .prev").on("click",function(){return 0===l.currentitemindex?l.changeitem(l.album.length-1):l.changeitem(l.currentitemindex-1),!1}),h.one("#mediabox-sidebar-actions .next").on("click",function(){return l.currentitemindex===l.album.length-1?l.changeitem(0):l.changeitem(l.currentitemindex+1),!1}),h.one("#mediabox-sidebar-actions .open").on("click",function(){return window.open(l.album[l.currentitemindex].getAttribute("data-url")+"?forcedownload=1","_blank"),!1}),h.one("#mediabox-sidebar-actions .mbclose").on("click",function(){return l.stop(),!1}),this._fullscreenavail&&h.one("#mediabox-sidebar-actions .fullscreen").on("click",function(){return screenfull.toggle(l.mediabox.getDOMNode()),l.setfullscreenimg(),!1}),this.setup_info_toggle()},updatenavbarselection:function(e){var t,i,a,n,o,d=this.navbar.one(".navitem.current");d&&d.removeClass("current"),this.navbar.one('.navitem[data-id="'+e+'"]').addClass("current"),t=h.one("#mediabox-navbar"),a=(i=h.one("#mediabox-navbar-container .current")).get("clientWidth")+2*parseInt(i.getStyle("margin-left"),10),n=h.all("#mediabox-navbar-container .navitem").indexOf(i),o=t.get("clientWidth")/2-a/2-n*a,h.one("#mediabox-navbar-container").setStyle("margin-left",o+"px")},changeitem:function(l){var r,t,e,i,a,s,n,o,d;this.currentitemindex!==l&&(r=this,t=h.one("#mediabox-content"),e=this.album[l].getAttribute("data-player"),i=this.album[l].getAttribute("data-type"),t.empty(),this.updatenavbarselection(l),a=new Image,"2"!==e&&"youtube"!==i&&(t.prepend(this._loadingimage),r.repositionitem(a.width,a.height),a.onload=function(){var e=h.Node.create("<img/>");e.setAttribute("src",r.album[l].getAttribute("href")),t.all("img").remove(),t.prepend(e),r.repositionitem(a.width,a.height
)},a.src=this.album[l].getAttribute("href")),this.currentitemindex=parseInt(l,10),this.currentitem=this.album[l],(s=h.one("#mediabox-metainfo")).empty(),(n=this.get("metainfodata")).id=this.currentitem.getAttribute(this.get("dataidfield")),n.action="metainfo",o={method:"GET",data:n,on:{success:function(e,t){var i,a,n,o;try{i=JSON.parse(t.responseText)}catch(d){return}for(a=0;a<i.fields.length;a++)""!==i.fields[a].value&&h.Node.create('<div class="metafield '+i.fields[a].name+'"></div>').append('<div class="metaname">'+i.fields[a].displayname+"</div>").append('<div class="metavalue">'+i.fields[a].value+"</div>").appendTo(s);i.commentcontrol&&(h.one("#mediabox-comments").setHTML(i.commentcontrol),n={client_id:i.client_id,contextid:i.contextid,itemid:this.album[l].getAttribute(this.get("dataidfield")),component:"mod_mediagallery",commentarea:"item",autostart:!0},M.core_comment!==undefined&&M.core_comment.init(h,n)),r.get("enablelikes")&&(o='<div class="like"></div>',i.likedbyme?(o='<div class="unlike"></div>',h.one("#mediabox-social a.like").setHTML(o+M.str.mod_mediagallery.unlike)):h.one("#mediabox-social a.like").setHTML(o+M.str.mod_mediagallery.like),this.update_likes(i.likes,i.likedbyme))}},context:this,sync:!0},""!==this.get("metainfouri")&&h.io(this.get("metainfouri"),o),"0"!==e&&"2"!==e||(this.embed_player(n.id),"0"===e?t.one(".mediaplugin").addClass("audio"):t.one(".mediaplugin").addClass("video")),"youtube"===this.currentitem.getAttribute("data-type")&&(t.empty(),d='<iframe id="mediabox-youtube" type="text/html" width="',d+=this._videowidth+'" height="'+this._videoheight+'" src="',d+=this.currentitem.getAttribute("data-url")+'" frameborder="0">',h.Node.create(d).appendTo(t),this.repositionitem()))},disablenav:function(){this.keyboardnav.detach()},embed_player:function(e){var t,i=this.get("metainfodata");i.id=e,i.action="embed",t={method:"GET",data:i,on:{success:function(e,t){var i,a=JSON.parse(t.responseText);h.one("#mediabox-content").setHTML(a.html),"video"===a.type&&(i=h.one("#mediabox-content .mediaplugin"),this.repositionitem(i.get("offsetWidth"),i.get("offsetHeight")))}},context:this,sync:!0},h.io(this.get("metainfouri"),t)},enable:function(){var t=this,e="a[rel^=mediabox], area[rel^=mediabox], a[data-mediabox], area[data-mediabox]";return h.one("body").all(e).on("click",function(e){return e.preventDefault(),t.start(h.one(e.currentTarget)),!1})},enablenav:function(){var t=this;this.keyboardnav=h.one(document).on("keyup",function(e){t.keyboardaction(e)})},keyboardaction:function(e){var t,i;i=e.keyCode,t=String.fromCharCode(i).toLowerCase(),27===i||t.match(/x|o|c/)?this.stop():"p"===t||37===i?0!==this.currentitemindex&&this.changeitem(this.currentitemindex-1):"n"!==t&&39!==i||this.currentitemindex!==this.album.length-1&&this.changeitem(this.currentitemindex+1)},repositionitem:function(e,t){var i,a,n,o,d,l,r="",s="",m=h.one("#mediabox-content"),c=m.get("children").get(0)[0],u=1,b="",g=M.util.get_string("thisdirection","core_langconfig");null!==this.currentitem&&(u=this.currentitem.getAttribute("data-player"),b=this.currentitem.getAttribute("data-type")),c!==undefined&&("2"===u||"youtube"===b?t=m.one(".mediaplugin.flow")?(e=this._videowidth,this._videoheight):(e=c.get("offsetWidth"),c.get("offsetHeight")):"0"===u?(e=this._audiowidth,t=this._audioheight):e===undefined&&(e=c.get("naturalWidth"),t=c.get("naturalHeight")),n=h.one("body").get("winWidth"),o=h.one("body").get("winHeight"),d=n-this.sidebarwidth(),l=o-this._navbarheight,d<e||l<t?(t/l<e/d?(r=d,a=0,i=(o-(s=parseInt(t/(e/d),10)))/2):(s=l,i=0,a=(n-(r=parseInt(e/(t/l),10))-this.sidebarwidth())/2),r+="px",s+="px"):(a=(n-e-this.sidebarwidth())/2,i=(o-t-this._navbarheight)/2),c.setStyle("width",r),c.setStyle("height",s),"0"===u&&m.one(".mediaplugin object")&&m.one(".mediaplugin object").setStyle("width",r),m.setStyle("top",i+"px"),"ltr"===g?m.setStyle("left",a+"px"):m.setStyle("right",a+"px"))},resizeoverlay:function(){var e=h.one("body").get("docWidth"),t=h.one("body").get("docHeight");this.overlay.setStyle("width",e),this.overlay.setStyle("height",t)},sidebarwidth:function(){return this.mediabox.hasClass("sidebarhidden")?0:this._sidebarwidth},start:function(e){var t,i,a=this;for(h.on("windowresize",function(){a.resizeoverlay(),a.repositionitem()}),h.one("body").addClass("noscroll mediaboxactive"),this.overlay.setStyle("display","block"),this.mediabox.setStyle("display","block"),i=t=0;i<this.album.length;i++)this.album[i].getAttribute("href")===e.getAttribute("href")&&(t=i);this.currentitemindex!==t&&h.one("#mediabox-content").empty(),this.setfullscreenimg(),this.changeitem(t),this.enablenav()},setfullscreenimg:function(){if(h.one("#mediabox-sidebar-actions .fullscreen")){var e=M.util.image_url("fullscreen","mod_mediagallery");screenfull.isFullscreen&&(e=M.util.image_url("fullscreenexit","mod_mediagallery")),h.one("#mediabox-sidebar-actions .fullscreen").setAttribute("src",e)}},setup_info_toggle:function(){var e,t,i,a=M.util.get_string("mediainformation","mod_mediagallery"),n=M.util.image_url("t/collapsed","moodle"),o=M.util.image_url("t/expanded","moodle"),d=h.Node.create('<img title="'+a+'"/>');d.setAttribute("src",n),(e=h.Node.create('<a href="#" class="toggle">'+a+"</a>")).prepend(d),(t=h.Node.create('<div class="metainfo-toggle"></div>')).prepend(e),h.one("#mediabox-sidebar").insertBefore(t,h.one("#mediabox-metainfo")),(i=h.one("#mediabox-metainfo")).toggleView(),h.delegate("click",function(e){e.preventDefault(),"hidden"===i.getAttribute("hidden")?d.setAttribute("src",o):d.setAttribute("src",n),i.toggleView()},"#mediabox","#mediabox-sidebar .metainfo-toggle a.toggle")},stop:function(){screenfull.isFullscreen&&screenfull.exit(),this.disablenav(),h.one("body").removeClass("noscroll mediaboxactive"),this.overlay.setStyle("display",""),this.mediabox.setStyle("display","")},update_likes:function(e,t){var i="";0<e&&(i="&nbsp;&bull;&nbsp;",i+=M.str.mod_mediagallery.likedby+": ",t&&(--e,i+=M.str.mod_mediagallery.you+", "),i+=e+" ",
i+=1!==e?M.str.mod_mediagallery.others:M.str.mod_mediagallery.other),h.one("#mediabox-likedby").setHTML(i)}},{NAME:"moodle-mod_mediagallery-mediabox",ATTRS:{enablecomments:{value:!0,validator:function(e){return h.Lang.isBoolean(e)}},enablelikes:{value:!0,validator:function(e){return h.Lang.isBoolean(e)}},metainfouri:{value:"",validator:function(e){return h.Lang.isString(e)}},dataidfield:{value:"data-id",validator:function(e){return h.Lang.isString(e)}},metainfodata:{value:{},validator:function(e){return h.Lang.isObject(e)}}}}),M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.init_mediabox=function(e){return new t(e)}},"@VERSION@",{requires:["base","node","selector-css3"]});